// <auto-generated/>
#nullable restore

using System.Text.Json.Nodes;
using Service.Api.Common;
using Service.Api.Common.ResponseStrategies;
using Service.Api.Common.RestHandlers;
using Service.Application.Common.Handlers;
using TestProject.Application.Commands;
using TestProject.Application.Queries;
using TestProject.Application.QueryResponses;

namespace TestProject;

public class RequestDispatcher(
    IRestHandler restHandler,
    IQueryParameterParser queryParameterParser,
    IHandler<GetRatingsQuery, GetRatingsQueryResponse> getRatingsHandler,
    IHandler<PostRatingsCommand, JsonObject> postRatingsHandler,
    IHandler<DeleteRatingsCommand, JsonObject> deleteRatingsHandler,
    IResponseStrategy<GetRatingsQuery, GetRatingsQueryResponse> getRatingsResponseStrategy,
    IResponseStrategy<PostRatingsCommand, JsonObject> postRatingsResponseStrategy,
    IResponseStrategy<DeleteRatingsCommand, JsonObject> deleteRatingsResponseStrategy) : IRequestDispatcher
{
    public async Task DispatchRequest(string[] pathParts, Request<JsonNode> requestData, CancellationToken cancellationToken)
    {
        switch (pathParts)
        {
            case ["get", "ratings"]:
                await restHandler.HandleRequest(requestData, pathParts, getRatingsResponseStrategy, getRatingsHandler, mergeGetRatings, cancellationToken);
                break;
            case ["post", "ratings"]:
                await restHandler.HandleRequest(requestData, pathParts, postRatingsResponseStrategy, postRatingsHandler, mergePostRatings, cancellationToken);
                break;
            case ["delete", "ratings"]:
                await restHandler.HandleRequest(requestData, pathParts, deleteRatingsResponseStrategy, deleteRatingsHandler, mergeDeleteRatings, cancellationToken);
                break;
        }
    }

    private (TestProject.Application.Queries.GetRatingsQuery, IEnumerable<ValidationError>) mergeGetRatings(TestProject.Application.Queries.GetRatingsQuery original, Dictionary<string, string> queryParameters, string[] pathParts)
    {
        var errors = Enumerable.Empty<ValidationError>();
        var merged = original;

        var (ids, idsErrors) = queryParameterParser.ParseGuid(original.Ids, queryParameters, "ids");

        if (!idsErrors.Any())
        {
            merged = original with
            {
                Ids = ids,
            };
        }
        else
        {
            errors = errors
                .Concat(idsErrors);
        }

        return (merged, errors);
    }

    private (TestProject.Application.Commands.PostRatingsCommand, IEnumerable<ValidationError>) mergePostRatings(TestProject.Application.Commands.PostRatingsCommand original, Dictionary<string, string> queryParameters, string[] pathParts)
    {
        var errors = Enumerable.Empty<ValidationError>();
        var merged = original;

        return (merged, errors);
    }

    private (TestProject.Application.Commands.DeleteRatingsCommand, IEnumerable<ValidationError>) mergeDeleteRatings(TestProject.Application.Commands.DeleteRatingsCommand original, Dictionary<string, string> queryParameters, string[] pathParts)
    {
        var errors = Enumerable.Empty<ValidationError>();
        var merged = original;

        var (ids, idsErrors) = queryParameterParser.ParseGuid(original.Ids, queryParameters, "ids");

        if (!idsErrors.Any())
        {
            merged = original with
            {
                Ids = ids,
            };
        }
        else
        {
            errors = errors
                .Concat(idsErrors);
        }

        return (merged, errors);
    }
}
